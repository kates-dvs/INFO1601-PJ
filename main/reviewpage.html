<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title id = "tile">Review Corner - Reviews</title>
    
    <link href="style.css" rel="stylesheet" type="text/css" />
 
  </head>
<style>

* {
    box-sizing: border-box;
    padding: 0.5em;
}

html,body{
  height: 100%;
  padding: 0;
  margin: 0;
}

header, footer{
  color: white;
  background-color: #2C2B2C ;
  grid-column: span 2;
} 

aside{
  display: grid;
  color: #212121;
  background-color: #E1D6C8;
  grid-template-rows: 2;
  row-gap: 5px;
}

section{
  background-color: #A785A6;
  color: white;
}

main{
  scroll-snap-type: y mandatory;
  grid-gap: 4px;
  background-color: #E1D6C8;
  color: white;
  max-width: 100%;
  overflow-y: scroll;
  border : solid ;
  
}

body{
  display: grid;
  background-color: #FFFFFF;
  grid-template-rows: 1fr 8fr 1fr;
  grid-template-columns: 2fr 8fr;
}
img{    
  padding: 5px;
  height : 100%;
  width: 70%;
  border-radius: 5px 5px 5px 5px;
  margin-left : auto;
  margin-right: auto;
  display : block ;
}
.title{
  text-align: center;
  color: black;
}
    
    div{
      color : black ;
    }
  #container{
    max-width : 100%;
  }
  #left{
    float:left; 
    width:50%;
    border : solid ;
  }
  #right{
    float:right; 
    width:50%;
    
  }

  textarea{
    resize:none;
    
  }

  img.logo{
    display: inline;
    width : 90px;
    height : 90px;
    float : right;
    border-radius: 50%;
  }
    #leftH{
      float: left;
      width:80%;
      text-align: center;
    }
    #rightH{
      float : right;
      width: 20%;
      height: 100%; 
      text-align: center;
    }

    #foot{
      text-align : center ;
    }

      ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
  overflow: hidden;
  background-color: #857364;
  
}

li {
  float: right;
}

li a {
  display: block;
  color: white;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}

li a:hover {
  background-color: #111;
  border-radius: 10px;
}


      .txt-center {
    text-align: center;
    
}
.hide {
    display: none;
}

.clear {
    float: none;
    clear: both;
}

.rating {
    width: 90px;
    unicode-bidi: bidi-override;
    direction: rtl;
    text-align: center;
    position: relative;
    display : inline ;
}

.rating > label {
    float: right;
    display: inline;
    padding: 0;
    margin: 0;
    position: relative;
    width: 1.1em;
    cursor: pointer;
    color: #000;
}

.rating > label:hover,
.rating > label:hover ~ label,
.rating > input.radio-btn:checked ~ label {
    color: transparent;
}

.rating > label:hover:before,
.rating > label:hover ~ label:before,
.rating > input.radio-btn:checked ~ label:before,
.rating > input.radio-btn:checked ~ label:before {
    content: "\2605";
    position: absolute;
    left: 0;
    color: #FFD700;
}
      #starForm{
        width:100%;
        height: 10%;
        
      }
#mission{
  float : left;
  color : white;
}
      #m{
        text-align: center;
      }

      #logoID{
        display : inline ;
        width : 50% ;
      }
    #t{
      display: inline;
      color : white ;
    }
  
</style>

  <body onload = review()>
    <header> 
      <div id = "leftH" >      
 <ul>
    
   <li><a class="active" href="library.html">Go Back</a></li>
  <li><a href="login.html">Login</a></li>
  <li><a href="register.html">Register</a></li>
  <li><a href="index.html">Home</a></li>
  <li id = "mission">Mission Statement: Here at Review Corner, we are determined to bring quality 
   books to the users.  </li>   
</ul>

      </div>
      <div id = "rightH">
        <p id = "t"> </p>
        <script>
          setInterval(myTimer, 1000);
    
          function myTimer() 
          {
          const date = new Date();
          document.getElementById("t").innerHTML = date.toLocaleTimeString();
          }
        </script>
      
      <img id = "logoID" src = "logo.jpg" class = "logo">
    </div>
           
    </header>
    <aside>
            <section id = "myPrev">
              
            </section>
    </aside>
 

    <main>
                                        
    <div id="left"> 

    <h1 class="title">Is this book worth a read?</h1>

      <picture id ="img">

        
      </picture>

    <p id = "m"> Leave a review and a rating. Share your voice </p> 

    <div class="txt-center">
    <form id = "starForm">
      Please select your rating of this book
        <div class="rating">
              
            <input id="star5" name="star" type="radio" value="1" class="radio-btn hide" />
            <label for="star5">☆</label>
            <input id="star4" name="star" type="radio" value="2" class="radio-btn hide" />
            <label for="star4">☆</label>
            <input id="star3" name="star" type="radio" value="3" class="radio-btn hide" />
            <label for="star3">☆</label>
            <input id="star2" name="star" type="radio" value="4" class="radio-btn hide" />
            <label for="star2">☆</label>
            <input id="star1" name="star" type="radio" value="5" class="radio-btn hide" />
            <label for="star1">☆</label>
            <div class="clear"></div>
          
        </div>
      <textarea rows="10" cols="50" name = "review">Write your review here</textarea>
      <br>
      <input type="submit" name="Submit" >
    </form>
</div>
        
  </div>                     
  <div id="right" > <h1 class="title">All Reviews for this book</h1>
  <picture id ="img2"></picture>

    <table>
     <thead>
       <tr>
           <th>Book Name</th> 
          <th>Reader Name</th>
            <th>Book Review</th>
      </tr>
      </thead>
      <tbody id ="tbody1">
        
      </tbody>
    </table>
    
  </div>                   
 
 
    </main>
    <footer id = "foot">All content protected by Copyright 2022</footer>
    
  </body>
   <script>
     function review(){
var data = sessionStorage.getItem("isbn1");
  console.log(data);
let img = document.getElementById("img");
let img2 = document.getElementById("img2");
let html = '';

fetch('https://api.sheety.co/504cf0647ef153be18864c788273571e/info1601Api/details')
.then((response) => response.json())
.then(json => {
 for(let details of json.details){
   if(details.isbn == data){
     html += `<img src = "${details.imageUrll}">`;
     img.innerHTML += html;
    img2.innerHTML += html;
     console.log(details.isbn);
console.log(details.imageUrll);
     bookRatings(details.bookTitle);
    
   }
 }
});
}

async function uploadInfo(url, data){
  try{
     let response = await fetch(
       url, 
       {
            method: 'POST',
            body: JSON.stringify(data),
         headers: { 'Content-Type':'application/json' }
       },
     );
     console.log(JSON.stringify(data));
     let result = await response.text();
     console.log(result);
   
   }catch(error){
     console.log(error);
   }
}


function submit2(event){
 event.preventDefault();
var data1 = sessionStorage.getItem("isbn1");
var currentUser = sessionStorage.getItem("thisUser");
console.log(currentUser);
 const starForm = event.target;
 const reviewData = new FormData(starForm);
 const moreData = Object.fromEntries(reviewData);
 let body = {
   "rating": {
     "username": currentUser,
     "isbn": data1,
     "bookRating": moreData.star,
     "review": moreData.review
   }
 }

if(currentUser != null){  uploadInfo('https://api.sheety.co/504cf0647ef153be18864c788273571e/info1601Api/ratings', body);
}else{
  window.location.href = "login.html";
}
}

document.forms['starForm'].addEventListener("submit",submit2);

function bookRatings(title){
 
 let display = document.getElementById("tbody1");
var isbnData = sessionStorage.getItem("isbn1");
  console.log(isbnData);

fetch('https://api.sheety.co/504cf0647ef153be18864c788273571e/info1601Api/ratings')
.then((response2) => response2.json())
.then(json2 => {
 for(let ratings of json2.ratings){
  if(ratings.isbn == isbnData){
    display.innerHTML += `<tr>
      <td>${title}</td>
      <td>${ratings.username}</td>
      <td><div>${ratings.bookRating}</div><div>${ratings.review}</div></td>
    </tr>`
    }
  }
});

}

var ifUser = sessionStorage.getItem("thisUser");

if(ifUser == null){
let doc5 = document.getElementById("myPrev");

doc5.innerHTML += `<a id = 'myPrev' href = "login.html">Login to view previous reviews</a><br>`
  
}else{
  let doc5 = document.getElementById("myPrev");
  doc5.innerHTML += `<a id = 'myPrev' href = "userpage.html">My Previous Reviews</a><br>`
}

//document.forms['starForm'].addEventListener("load",previous);
   </script>
</html>
